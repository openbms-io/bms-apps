# ADR 002: Template HTTP URIs vs Instance URNs

**Date**: 2025-11-13
**Status**: Accepted
**Context**: Story 2.7 implementation - Templates endpoint

## Decision

### Templates Use HTTP URIs

Templates are ASHRAE 223P class definitions and use official HTTP URIs:

- **Format**: `http://data.ashrae.org/standard223#Damper`
- **Source**: ASHRAE 223P ontology
- **Usage**: Templates endpoint (Story 2.7) returns these HTTP URIs
- **Purpose**: Identify class definitions in the ASHRAE 223P standard

### Instances Use URNs

Instances are specific equipment in buildings and use project-specific URNs:

- **Format**: `urn:building/project-123/vav-101-damper`
- **Source**: Generated by our system
- **Usage**: Mappings endpoint (Story 2.8+) creates these URN instances
- **Purpose**: Identify specific equipment in specific projects

### RDF Relationship

Instances assert type relationship to templates:

```turtle
urn:building/project-123/vav-101-damper rdf:type http://data.ashrae.org/standard223#Damper .
```

## Rationale

1. **ASHRAE 223P Standard Compliance**: HTTP URIs are the official identifiers in the ASHRAE 223P ontology
2. **Semantic Web Standards**: RDF uses HTTP URIs for class definitions
3. **SHACL Validation**: Story 2.10 SHACL validation requires official ASHRAE 223P URIs
4. **Separation of Concerns**: Templates (types) vs Instances (data) use different identifier schemes

## Consequences

### Breaking Change from Epic 1

- **Epic 1 mock**: `urn:ashrae:223p:Damper`
- **Real ASHRAE 223P**: `http://data.ashrae.org/standard223#Damper`
- **Impact**: Frontend DTO `id` field value changes (contract unchanged)

### Frontend Impact

- No code changes required
- Dropdowns still work with HTTP URIs
- Designer app treats them as opaque identifiers

### Future Story Impact

- **Story 2.8 (Mappings)**: Will create URN instances
- **Story 2.10 (SHACL)**: Validates against HTTP URI class definitions
- **Story 2.13 (AI Suggestions)**: Uses templates (HTTP URIs) for recommendations

## Implementation Details

### Template Mapper (Story 2.7)

Extract HTTP URIs directly from BuildingMOTIF RDF graph:

```python
def extract_rdf_class_uri(template: Template) -> str:
    """Extract ASHRAE 223P HTTP URI from RDF graph."""
    s223 = Namespace("http://data.ashrae.org/standard223#")
    for subj, pred, obj in template.body:
        if pred == RDF.type and str(obj).startswith(str(s223)):
            return str(obj)  # Returns: http://data.ashrae.org/standard223#Damper
    raise ValueError(f'No s223 class URI found in {template.name}')
```

### Instance Creation (Story 2.8+)

Create URN instances when user maps BACnet points:

```python
# User maps point "point-123" to Damper template
namespace = "urn:building/project-abc"  # Project-specific
instance_id = f"{namespace}/point-123"  # â†’ "urn:building/project-abc/point-123"

# Assert instance type relationship to template
graph.add((
    URIRef(instance_id),
    RDF.type,
    URIRef("http://data.ashrae.org/standard223#Damper")
))
```

## References

- [ASHRAE 223P Ontology](http://data.ashrae.org/standard223)
- [BuildingMOTIF Documentation](https://buildingmotif.readthedocs.io/)
- [RDF Primer](https://www.w3.org/TR/rdf11-primer/)
- [test_template_uri_discovery.py](../../../apps/building-semantics-api-app/tests/integration/test_template_uri_discovery.py)
- [Story 2.7: Implement Templates Endpoint](../stories/2-7-implement-templates-endpoint.md)

## Alternatives Considered

### Alternative 1: Custom URN Format for Templates

**Rejected**: Would require manual mapping between our URNs and ASHRAE 223P URIs, breaking standard compliance and SHACL validation.

```python
# Rejected approach
def extract_custom_urn(template: Template) -> str:
    class_name = extract_class_name(template)
    return f"urn:ashrae:223p:{class_name}"  # Custom URN
```

### Alternative 2: URNs for Both Templates and Instances

**Rejected**: Templates are not instances - they are class definitions. Using URNs for class definitions violates RDF/OWL standards.

### Alternative 3: HTTP URIs for Both Templates and Instances

**Rejected**: Instances need project-specific identifiers. HTTP URIs imply globally resolvable resources, which project instances are not.

## Decision Log

- **2025-11-13**: Initial decision - templates use HTTP URIs, instances use URNs
- **2025-11-13**: Confirmed after clarifying BuildingMOTIF uses both formats for different purposes
- **2025-11-13**: Documented in ADR, Story 2.7 markdown, context XML, and test file
