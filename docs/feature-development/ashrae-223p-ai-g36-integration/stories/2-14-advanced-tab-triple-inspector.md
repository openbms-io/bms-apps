# Story 2.14: Advanced Tab - Triple Inspector

**Epic:** Epic 2 - BuildingMOTIF API Integration
**Phase:** Phase 3 - Enhancement (Post Phase 2 completion)
**Status:** backlog
**Created:** 2025-11-16
**Complexity:** TBD (requires refinement)
**Estimated Hours:** TBD (requires architecture decisions)

**‚ö†Ô∏è NEEDS REFINEMENT - Architecture Decisions Required**

This story requires architectural decisions before implementation:
1. **UI Design**: How to display RDF triples in the Advanced tab (tree view, table, graph visualization?)
2. **Data Transfer**: How to pass triple data from backend to frontend (preview endpoint, expand existing endpoint?)
3. **Categorization**: Confirm the 6 categories for grouping triples
4. **Performance**: Lazy loading strategy for large triple sets (100+ triples)
5. **Serialization**: Format for triple data (JSON, Turtle, JSON-LD?)

---

## User Story

**As a** BMS integrator,
**I want** to see all ASHRAE 223P RDF triples generated by `template.fill()` in an Advanced tab,
**So that** I understand the complete semantic graph structure that BuildingMOTIF will create before saving.

---

## Context

### Problem

Currently, the mappings endpoint returns **only 5 fields** to the frontend:
- `equipmentTypeId`
- `deviceTypeId`
- `propertyId`
- `physicalSpaceId` (optional)
- `domainSpaceIds` (optional)

However, BuildingMOTIF creates **20-50+ RDF triples** via `template.fill()` for each mapping:
- Type declarations (`rdf:type`)
- Property characteristics (`qudt:hasQuantityKind`, `s223:hasMedium`, `s223:hasAspect`)
- Connection topology (`s223:contains`, `s223:connectedTo`, `s223:cnx`)
- Functional mappings (`s223:mapsTo`, `s223:hasObservationLocation`)
- Space relationships (`s223:locatedIn`, `s223:hasDomain`)
- BACnet references (`bacnet:device-identifier`, `bacnet:object-identifier`)

**95% of the semantic graph is currently hidden from users.**

### Solution

Add an "Advanced" tab to the mapping popup modal that displays **all generated RDF triples** grouped by category, allowing users to:
- See the complete ASHRAE 223P semantic structure
- Verify relationships before saving
- Copy Turtle/JSON-LD for documentation
- Learn ASHRAE 223P ontology relationships

---

## What Gets Generated by template.fill()

When a mapping is saved, BuildingMOTIF calls:

```python
equipment_bindings, equipment_graph = equipment_template.fill(BMS)
device_bindings, device_graph = device_template.fill(BMS)
property_bindings, property_graph = property_template.fill(BMS)
```

These graphs contain **all ASHRAE 223P relationships** defined in the templates.

---

## Proposed Triple Categories (6 Groups)

### 1. Type/Classification
Instance type declarations
- `rdf:type`

### 2. Properties
Observable/actuatable characteristics
- `s223:hasProperty`
- `qudt:hasQuantityKind`
- `s223:hasAspect`
- `s223:hasMedium`
- `s223:hasEnumerationKind`
- `qudt:hasUnit`

### 3. Connection/Topology
Physical/logical connectivity
- `s223:contains`
- `s223:connectedTo`
- `s223:cnx`
- `s223:hasConnectionPoint`

### 4. Function/Mapping
Functional relationships
- `s223:mapsTo`
- `s223:hasObservationLocation`
- `s223:observes`
- `s223:actuates`

### 5. Space
Location relationships
- `s223:locatedIn`
- `s223:hasDomain`

### 6. External Reference
BACnet/IoT integration
- `s223:hasExternalReference`
- `bacnet:device-identifier`
- `bacnet:object-identifier`
- `dcterms:identifier`

---

## Architecture Decisions Required

### Decision 1: UI Display Format

**Options:**
- **A**: Tree view with collapse/expand (shadcn/ui Collapsible)
- **B**: Table view with filters by category
- **C**: Graph visualization (D3.js, force-directed graph)
- **D**: Tabs for each category

**Recommendation:** TBD (needs UX review)

---

### Decision 2: Data Transfer Method

**Options:**
- **A**: New endpoint `POST /api/v1/223p/mappings/preview-triples`
  - Pros: Clean separation, doesn't bloat main endpoint
  - Cons: Extra API call
- **B**: Expand existing `GET /api/v1/223p/mappings` with `?includeTriples=true`
  - Pros: Single request
  - Cons: Bloats response size
- **C**: Frontend-only: Fetch templates, simulate triple generation
  - Pros: No backend changes
  - Cons: Inaccurate, doesn't show actual BuildingMOTIF output

**Recommendation:** TBD (needs backend review)

---

### Decision 3: Triple Categorization Logic

**Where to categorize?**
- **A**: Backend categorizes, sends pre-grouped JSON
- **B**: Backend sends flat triple list, frontend categorizes
- **C**: Backend sends raw Turtle, frontend parses

**Recommendation:** TBD

---

### Decision 4: Performance Strategy

**For large triple sets (100+ triples):**
- **A**: Lazy load - only fetch when Advanced tab opened
- **B**: Pagination - show 20 triples at a time
- **C**: Virtual scrolling - render visible triples only
- **D**: Limit display - show first 50, "Show all" button

**Recommendation:** TBD

---

### Decision 5: Serialization Format

**What format to return?**
- **A**: JSON array of `{subject, predicate, object, objectType}`
- **B**: Turtle string (frontend parses)
- **C**: JSON-LD (native RDF JSON)
- **D**: Mixed - JSON for display + Turtle for copy

**Recommendation:** TBD

---

## Acceptance Criteria (Draft - Subject to Refinement)

**AC #1: Display All Generated Triples**
- Show all RDF triples from `template.fill()` calls
- Group by 6 categories (Type, Properties, Connection, Function, Space, Reference)
- Collapsible sections for each category

**AC #2: Real-time Preview**
- Call BuildingMOTIF `template.fill()` when Advanced tab opened
- Show actual triples that will be created
- Update when user changes selections in Mapping tab

**AC #3: Copy Functionality**
- "Copy as Turtle" button - RDF serialization
- "Copy as JSON-LD" button - JSON format
- "Copy Composite Key" button

**AC #4: Performance**
- Preview generation < 500ms
- Handle 100+ triples without UI lag
- Lazy load (only fetch when tab opened)

**AC #5: Visual Formatting**
- Color-coded predicates (s223: blue, qudt: green, bacnet: orange)
- Monospace font for URIs
- Proper indentation/tree structure
- Responsive layout

---

## Tasks (Preliminary - Requires Architecture Decisions)

### Backend Tasks (TBD)

**Task 1**: Design preview endpoint API contract
- Decide on endpoint path and method
- Define request/response DTOs
- Determine categorization logic location

**Task 2**: Implement triple generation logic
- Call `template.fill()` for selected templates
- Substitute URNs with custom URIs
- Categorize triples into 6 groups
- Serialize to chosen format

**Task 3**: Add serialization helpers
- Turtle serialization
- JSON-LD serialization (if needed)
- Triple categorization function

### Frontend Tasks (TBD)

**Task 4**: Design UI components
- Decide on display format (tree, table, graph)
- Create mockups/wireframes
- Get UX approval

**Task 5**: Implement TripleViewer component
- Display triples in chosen format
- Collapse/expand sections
- Color-coding and formatting

**Task 6**: Add preview mutation hook
- Call preview endpoint
- Handle loading/error states
- Cache results during modal session

**Task 7**: Integrate into mapping popup modal
- Add shadcn/ui Tabs component
- Add "Advanced" tab
- Pass form state to preview
- Add copy functionality

**Task 8**: Testing
- Backend: Test triple generation accuracy
- Frontend: Test UI performance with 100+ triples
- Integration: End-to-end preview workflow

---

## Example Output (Conceptual)

```
üìã Type/Classification (3 triples)
  ‚îî‚îÄ <urn:bms:Equipment:...> rdf:type s223:TerminalUnit
  ‚îî‚îÄ <urn:bms:Device:...> rdf:type s223:Damper
  ‚îî‚îÄ <urn:bms:Property:...> rdf:type s223:QuantifiableObservableProperty

üîß Properties (5 triples)
  ‚îî‚îÄ <device> s223:hasProperty <property>
  ‚îî‚îÄ <property> qudt:hasQuantityKind qudt:Dimensionless
  ‚îî‚îÄ <property> s223:hasAspect s223:Role-Command
  ‚îî‚îÄ <property> s223:hasMedium s223:Medium-Air
  ‚îî‚îÄ <property> qudt:hasUnit unit:PERCENT

üîó Connection/Topology (4 triples)
  ‚îî‚îÄ <equipment> s223:contains <device>
  ‚îî‚îÄ <equipment> s223:connectedTo <supplyDuct>
  ‚îî‚îÄ <equipment> s223:cnx <inletPoint>
  ‚îî‚îÄ <equipment> s223:hasConnectionPoint <outletPoint>

‚öôÔ∏è Function/Mapping (2 triples)
  ‚îî‚îÄ <connectionPoint> s223:mapsTo <functionBlock>
  ‚îî‚îÄ <property> s223:hasObservationLocation <location>

üè¢ Space (3 triples)
  ‚îî‚îÄ <equipment> s223:locatedIn <MechanicalRoom>
  ‚îî‚îÄ <equipment> s223:hasDomain <ConferenceA>
  ‚îî‚îÄ <equipment> s223:hasDomain <ConferenceB>

üîå External Reference (4 triples)
  ‚îî‚îÄ <equipment> s223:hasExternalReference <bacnetRef>
  ‚îî‚îÄ <bacnetRef> rdf:type s223:BACnetExternalReference
  ‚îî‚îÄ <bacnetRef> bacnet:device-identifier "device,123"
  ‚îî‚îÄ <bacnetRef> bacnet:object-identifier "analog-input,1"

Total: 21 triples
[Copy as Turtle] [Copy as JSON-LD] [Copy Composite Key]
```

---

## Dependencies

- Story 2.6: BuildingMOTIF SDK Setup ‚úÖ
- Story 2.7: Templates Endpoint ‚úÖ
- Story 2.8: Mappings Endpoints ‚úÖ
- Architecture decisions: ‚ùå REQUIRED BEFORE IMPLEMENTATION

---

## Estimated Effort (Preliminary)

**Complexity:** 4-5 (Medium-High, depending on architecture choices)
**Estimated Hours:** 10-16 hours
- Architecture decisions: 2 hours
- Backend preview endpoint: 4-6 hours
- Frontend TripleViewer component: 4-6 hours
- Integration & testing: 2-4 hours

**NOTE:** Effort may change significantly based on architecture decisions.

---

## Next Steps

1. **Architectural Review**: Discuss 5 architecture decisions with team
2. **UX Design**: Create mockups for Advanced tab UI
3. **API Design**: Define preview endpoint contract
4. **Update Story**: Revise AC and tasks based on decisions
5. **Implementation**: Begin after architecture approval

---

## Dev Notes

### Why This Matters

**Current State:**
- Users only see 5 fields (template IDs + space IDs)
- Backend creates 20-50+ triples via `template.fill()`
- **95% of semantic graph hidden from users**

**With Triple Inspector:**
- **Full Transparency**: See ALL RDF relationships
- **Learning**: Understand ASHRAE 223P ontology structure
- **Debugging**: Verify correct relationships before saving
- **Documentation**: Export Turtle/JSON-LD for external tools
- **Trust**: Users understand what's being created

### References

- BuildingMOTIF `template.fill()`: `/Users/amol/miniconda3/lib/python3.11/site-packages/buildingmotif/`
- Test examples: `apps/building-semantics-api-app/tests/integration/test_template_urn_extraction.py`
- Current mapper: `apps/building-semantics-api-app/src/mappers/mapping_mapper.py:96-204`

---

## Status

**Status:** backlog
**Blocked By:** Architecture decisions required
**Ready For:** Architecture review meeting

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Completion Notes

**2025-11-16: Story Created - Needs Refinement**

Created Story 2.14 to expose RDF triples generated by BuildingMOTIF's `template.fill()`.

**Architecture Decisions Required:**
1. UI display format (tree, table, graph, tabs)
2. Data transfer method (new endpoint, expand existing, frontend-only)
3. Triple categorization logic (backend vs frontend)
4. Performance strategy (lazy load, pagination, virtual scroll)
5. Serialization format (JSON, Turtle, JSON-LD, mixed)

**Current State:**
- Mappings endpoint returns only 5 fields
- BuildingMOTIF creates 20-50+ RDF triples per mapping
- 95% of semantic graph hidden from users

**Proposed Solution:**
- Advanced tab in mapping popup modal
- Display all triples grouped by 6 categories
- Copy functionality (Turtle, JSON-LD, composite key)

**Next Steps:**
- Architecture review meeting
- UX design (mockups)
- API contract definition
- Story refinement after decisions

### File List

- Story file: `docs/feature-development/ashrae-223p-ai-g36-integration/stories/2-14-advanced-tab-triple-inspector.md`
