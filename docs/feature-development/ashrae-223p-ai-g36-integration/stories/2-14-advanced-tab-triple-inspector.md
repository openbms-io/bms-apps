# Story 2.14: Advanced Tab - ASHRAE 223P Graph Visualization

**Epic:** Epic 2 - BuildingMOTIF API Integration
**Phase:** Phase 3 - Enhancement (Post Phase 2 completion)
**Status:** backlog
**Created:** 2025-11-16
**Complexity:** 2
**Estimated Hours:** 4-6 hours

---

## User Story

**As a** BMS integrator,
**I want** to see a visual graph of ASHRAE 223P relationships generated by BuildingMOTIF,
**So that** I understand the complete semantic structure before saving a mapping.

---

## Context

### Problem

Currently, the mappings endpoint returns **only 5 fields** to the frontend:

- `equipmentTypeId`
- `deviceTypeId`
- `propertyId`
- `physicalSpaceId` (optional)
- `domainSpaceIds` (optional)

However, BuildingMOTIF creates **20-50+ RDF triples** via `template.fill()` for each mapping:

- Type declarations (`rdf:type`)
- Property characteristics (`qudt:hasQuantityKind`, `s223:hasMedium`, `s223:hasAspect`)
- Connection topology (`s223:contains`, `s223:connectedTo`, `s223:cnx`)
- Functional mappings (`s223:mapsTo`, `s223:hasObservationLocation`)
- Space relationships (`s223:locatedIn`, `s223:hasDomain`)
- BACnet references (`bacnet:device-identifier`, `bacnet:object-identifier`)

**95% of the semantic graph is currently hidden from users.**

### Solution

Add an "Advanced" tab to the mapping popup modal with a **React Flow graph visualization** that:

- Shows the complete ASHRAE 223P semantic structure visually
- Displays equipment → device → property hierarchy
- Shows connection topology, space relationships, and BACnet references
- Enables zoom, pan, and exploration of the generated graph
- Helps users learn ASHRAE 223P ontology relationships through visual representation

---

## What Gets Generated by template.fill()

When a mapping is saved, BuildingMOTIF calls:

```python
equipment_bindings, equipment_graph = equipment_template.fill(BMS)
device_bindings, device_graph = device_template.fill(BMS)
property_bindings, property_graph = property_template.fill(BMS)
```

These graphs contain **all ASHRAE 223P relationships** defined in the templates.

---

## Implementation Approach

### Technology Choice: React Flow

**Why React Flow:**

- ✅ Already installed in the project (`apps/designer`)
- ✅ Built-in zoom, pan, minimap capabilities
- ✅ Auto-layout algorithms (dagre, elk)
- ✅ Handles 100+ nodes with good performance
- ✅ Visual learning - users SEE the ontology structure
- ✅ Minimal custom code required

### Architecture

**Backend:**

- New endpoint: `POST /api/v1/223p/mappings/preview-graph`
- Calls `template.fill()` for equipment, device, property templates
- Converts RDF triples to React Flow format: `{nodes: [...], edges: [...]}`
- Returns JSON array with subject/predicate/object as nodes/edges

**Frontend:**

- Add "Advanced" tab to existing mapping popup modal (Story 2.8)
- Create `MappingGraphViewer` component using React Flow
- Lazy load - only fetch graph when Advanced tab is opened
- Use dagre layout algorithm for hierarchical display

**Node Types:**

- Equipment (blue): TerminalUnit, DualDuctTerminal, etc.
- Device (green): Damper, Valve, Sensor, etc.
- Property (orange): QuantifiableObservableProperty, etc.
- Connection Point (gray): InletConnectionPoint, OutletConnectionPoint
- Space (purple): PhysicalSpace, DomainSpace
- External Reference (red): BACnetExternalReference

**Edge Types:**

- Containment: `s223:contains`
- Connection: `s223:connectedTo`, `s223:cnx`
- Property: `s223:hasProperty`
- Location: `s223:locatedIn`, `s223:hasDomain`
- Type: `rdf:type`
- Characteristics: `qudt:hasQuantityKind`, `s223:hasMedium`, etc.

---

## Acceptance Criteria

**AC #1: Graph Visualization Display**

- Display React Flow graph with all nodes and edges from `template.fill()` calls
- Show equipment → device → property hierarchy
- Include connection topology, space relationships, and external references
- Use color coding by node type (equipment=blue, device=green, property=orange, etc.)

**AC #2: Real-time Preview**

- Call BuildingMOTIF `template.fill()` when Advanced tab is opened
- Show actual graph structure that will be created
- Lazy load - only fetch when tab is opened (not on modal open)

**AC #3: Interactivity**

- Enable zoom in/out functionality
- Enable pan/drag to explore graph
- Fit view button to reset zoom/position
- Node labels display entity type and identifier

**AC #4: Performance**

- Preview generation completes without blocking UI
- Handle 100+ nodes/edges without lag
- Use React Flow's built-in virtualization for large graphs

**AC #5: Integration**

- Add "Advanced" tab to existing mapping popup modal (from Story 2.8)
- Tab only appears after user has selected equipment, device, and property
- Graph updates when user changes selections in Mapping tab

---

## Tasks (TDD Workflow)

### Backend Tasks (2-3 hours)

**Task 1: Write Tests First (pytest)**

```python
# apps/building-semantics-api-app/tests/integration/test_routers/test_graph_preview.py
test_preview_graph_endpoint_returns_nodes_and_edges()
test_preview_graph_converts_equipment_device_property_to_react_flow()
test_preview_graph_includes_space_relationships()
test_preview_graph_includes_external_references()
test_preview_graph_handles_missing_optional_spaces()
```

**Task 2: Implement Preview Endpoint**

- Create `POST /api/v1/223p/mappings/preview-graph` endpoint
- Request DTO: `{equipmentTypeId, deviceTypeId, propertyId, physicalSpaceId?, domainSpaceIds?}`
- Response DTO: `{nodes: ReactFlowNode[], edges: ReactFlowEdge[]}`

**Task 3: Implement Triple-to-Graph Converter**

- Create service function: `convert_template_graphs_to_react_flow()`
- Call `template.fill()` for equipment, device, property templates
- Extract unique subjects/objects as nodes
- Extract predicates as edges
- Assign node types and colors based on RDF type

---

### Frontend Tasks (2-3 hours)

**Task 4: Write Tests First (Jest + RTL)**

```typescript
// apps/designer/src/components/MappingGraphViewer.spec.tsx
test_advanced_tab_renders_in_mapping_modal();
test_preview_graph_fetched_when_advanced_tab_opened();
test_react_flow_displays_nodes_and_edges();
test_graph_updates_when_mapping_form_changes();
test_fit_view_button_resets_zoom_and_position();
```

**Task 5: Create MappingGraphViewer Component**

- Create `apps/designer/src/components/MappingGraphViewer.tsx`
- Use React Flow with dagre layout
- Implement custom node types for different entity types
- Add color coding (equipment=blue, device=green, property=orange)
- Add fit view button

**Task 6: Add Preview Graph Hook**

- Create `usePreviewMappingGraph()` mutation hook
- Call `POST /api/v1/223p/mappings/preview-graph`
- Handle loading/error states
- Cache results during modal session

**Task 7: Integrate into Mapping Modal**

- Add "Advanced" tab to existing mapping popup (Story 2.8)
- Lazy load graph when tab is opened
- Pass form state to preview hook
- Update graph when form changes

---

### Integration Testing

**Task 8: End-to-End Test**

- Test complete flow: Select mapping → Open Advanced tab → View graph
- Verify graph shows equipment → device → property hierarchy
- Verify space relationships displayed
- Test with 50+ nodes for performance

---

## Example Output (React Flow Graph)

```
┌─────────────────────────────────────────────────────────────┐
│                    Advanced Tab - Graph View                 │
├─────────────────────────────────────────────────────────────┤
│  [Fit View] [Zoom In] [Zoom Out]                            │
│                                                              │
│         ┌───────────────────┐                               │
│         │  MechanicalRoom   │ (purple)                      │
│         │   PhysicalSpace   │                               │
│         └────────┬──────────┘                               │
│                  │ s223:locatedIn                           │
│                  ↓                                           │
│         ┌───────────────────┐                               │
│         │      VAV-1        │ (blue)                        │
│         │   TerminalUnit    │                               │
│         └────────┬──────────┘                               │
│                  │ s223:contains                            │
│                  ↓                                           │
│         ┌───────────────────┐                               │
│         │    Damper-1       │ (green)                       │
│         │      Damper       │                               │
│         └────────┬──────────┘                               │
│                  │ s223:hasProperty                         │
│                  ↓                                           │
│         ┌───────────────────┐                               │
│         │ DamperCommand-1   │ (orange)                      │
│         │ QuantifiableActu  │                               │
│         │ atableProperty    │                               │
│         └────────┬──────────┘                               │
│                  │                                           │
│         ┌────────┴────────┬──────────┬──────────┐          │
│         ↓                 ↓          ↓          ↓          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ Medium-  │  │ Role-    │  │Dimension │  │ unit:    │  │
│  │ Air      │  │ Command  │  │ less     │  │ PERCENT  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
│                                                              │
│  Nodes: 12 | Edges: 15 | Layout: dagre (hierarchical)      │
└─────────────────────────────────────────────────────────────┘

Legend:
- Blue nodes: Equipment (TerminalUnit, etc.)
- Green nodes: Devices (Damper, Valve, Sensor)
- Orange nodes: Properties (QuantifiableObservableProperty)
- Purple nodes: Spaces (PhysicalSpace, DomainSpace)
- Gray nodes: Connection Points
- Red nodes: External References (BACnet)
```

---

## Dependencies

- Story 2.6: BuildingMOTIF SDK Setup ✅
- Story 2.7: Templates Endpoint ✅
- Story 2.8: Mappings Endpoints ✅
- React Flow (already installed in designer app) ✅

---

## Estimated Effort

**Complexity:** 2 (Low - leverages existing React Flow library)
**Estimated Hours:** 4-6 hours

**Breakdown:**

- Backend preview endpoint: 2-3 hours
  - Write tests (30 min)
  - Create endpoint (1 hour)
  - Implement triple-to-graph converter (1-1.5 hours)
- Frontend graph viewer: 2-3 hours
  - Write tests (30 min)
  - Create MappingGraphViewer component (1 hour)
  - Add preview hook (30 min)
  - Integrate into mapping modal (30-1 hour)

---

## Next Steps

1. **Begin Implementation**: Story ready for development (no architecture decisions needed)
2. **Follow TDD Workflow**: Write tests first, then implement
3. **Test with Real Data**: Use actual BuildingMOTIF templates to verify graph structure

---

## Dev Notes

### Why This Matters

**Current State:**

- Users only see 5 fields (template IDs + space IDs)
- Backend creates 20-50+ triples via `template.fill()`
- **95% of semantic graph hidden from users**

**With React Flow Graph:**

- **Visual Understanding**: SEE the complete ASHRAE 223P structure
- **Learning**: Graph visualization helps users learn ontology relationships
- **Debugging**: Verify correct relationships before saving
- **Trust**: Users understand what's being created
- **Simple Implementation**: Leverages existing React Flow library

### Why React Flow?

**Aligns with Project Philosophy:**

- ✅ **DO NOT OVERENGINEER**: Uses existing library, minimal custom code
- ✅ **YAGNI**: No premature features (Turtle export, categorization, etc.)
- ✅ **Simple/Direct**: One button → one graph visualization
- ✅ **Fail Fast**: Preview shows errors before saving

**Technical Benefits:**

- Already in project (apps/designer uses it)
- Built-in zoom, pan, minimap
- Auto-layout with dagre/elk
- Handles 100+ nodes efficiently
- No categorization logic needed - graph shows relationships naturally

### References

- BuildingMOTIF `template.fill()`: `/Users/amol/miniconda3/lib/python3.11/site-packages/buildingmotif/`
- Test examples: `apps/building-semantics-api-app/tests/integration/test_template_urn_extraction.py`
- Current mapper: `apps/building-semantics-api-app/src/mappers/mapping_mapper.py:96-204`
- React Flow docs: https://reactflow.dev/
- dagre layout: https://github.com/dagrejs/dagre

---

## Status

**Status:** backlog
**Ready For:** Implementation (no blockers)

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Completion Notes

**2025-11-17: Story Refined - React Flow Graph Approach**

Simplified Story 2.14 based on project philosophy (DO NOT OVERENGINEER, YAGNI).

**Original Approach (Rejected):**

- Multiple architecture decisions required
- Triple categorization (6 groups)
- Multiple serialization formats (Turtle, JSON-LD, JSON)
- Color-coded predicates
- Complexity: 5/10, Estimated: 10-16 hours

**New Approach (React Flow Graph):**

- Simple visualization using existing React Flow library
- Single endpoint: `POST /api/v1/223p/mappings/preview-graph`
- Returns `{nodes, edges}` for React Flow
- Dagre auto-layout for hierarchy
- Complexity: 2/10, Estimated: 4-6 hours

**Alignment with Project Philosophy:**

- ✅ DO NOT OVERENGINEER: Uses existing library
- ✅ YAGNI: No premature features (export, categorization)
- ✅ Simple/Direct: One button → one graph
- ✅ TDD: Specific test names defined

**Ready for implementation** - no architecture decisions needed.

### File List

- Story file: `docs/feature-development/ashrae-223p-ai-g36-integration/stories/2-14-advanced-tab-triple-inspector.md`
